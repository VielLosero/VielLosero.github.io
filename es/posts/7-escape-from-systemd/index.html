<!DOCTYPE html>
<html><head>
<title>Viel Losero - Escapar de systemd: Creando nuestra propia iso kali-i3-viel.</title>
<link rel="stylesheet" href="../../../css/main.css"/>
<link rel="stylesheet" href="../../../css/syntax.css" />
<link href="https://fonts.googleapis.com/css?family=Nunito|Roboto&display=swap" rel="stylesheet">
</head>
<body><header class="homepage-header">
<div class="banner">
    <a href="../../../"><img src="../../../images/v.svg" alt="logo" /></a>
	<div>
	<a id="name" href="../../../"><h1>Viel Losero&#39; website</h1></a>
        <nav class="MenuNav"> 
                                                                                                                                     
                                                                                                                                  
                <a class="sidebar-nav-item" href="../../../es/posts/" title="">Publicaciones</a>
		                                                                                                                  
                <a class="sidebar-nav-item" href="../../../es/contacto/" title="">Contacto</a>
		                                                                                                                  
                <a class="sidebar-nav-item" href="../../../es/acerca/" title="">Acerca</a>
		                                                                                                                  
                <a class="sidebar-nav-item" href="../../../es/support/" title="">Apoyo</a>
		
        </nav>        
</div>
</div>

</header>
<section>
		<div id=content>
<main>
    <article>
        <header class="article-header">
            <h1> Escapar de systemd: Creando nuestra propia iso kali-i3-viel.</h1>
        </header>
	 <article>
		<div class="post-meta">
		<p id="post-date"> Posted: Nov 8, 2019 - [ 3051 Words ] 
		
		    
		       - [ <a href="../../../en/posts/7-escape-from-systemd/">en</a> ]
		    
                                                                                                                                                     
		</p>
		</div>
		 <p id="toc">Table of contents <nav id="TableOfContents">
  <ul>
    <li><a href="#comparando-systemas-de-inicio">Comparando systemas de inicio</a></li>
    <li><a href="#por-que-sysv-init">Por que sysV-init</a></li>
    <li><a href="#removiendo-systemd">Removiendo systemd</a></li>
    <li><a href="#todo-depende-de-systemd">Todo depende de systemd</a></li>
  </ul>

  <ul>
    <li><a href="#clonando-live-build-config">Clonando live-build-config</a>
      <ul>
        <li><a href="#creando-nuestra-variante">Creando nuestra variante</a></li>
      </ul>
    </li>
    <li><a href="#primer-intento-para-crear-la-iso">Primer intento para crear la iso</a>
      <ul>
        <li><a href="#copiando-mi-config-para-i3">Copiando mi config para i3</a></li>
        <li><a href="#añadiendo-algunos-paquetes">Añadiendo algunos paquetes</a></li>
        <li><a href="#construyendo-la-iso--building">Construyendo la iso &hellip; building</a></li>
      </ul>
    </li>
    <li><a href="#segundo-intento--ronda-dos">Segundo intento .. ronda dos.</a>
      <ul>
        <li><a href="#cambiando-systemd-por-sysvinit">Cambiando systemd por sysvinit</a></li>
        <li><a href="#empezando-con-lo-minimo">Empezando con lo minimo</a></li>
        <li><a href="#cambiando-locales">Cambiando locales</a></li>
        <li><a href="#resolución-de-pantalla">Resolución de pantalla</a></li>
        <li><a href="#deshabilitando-servicios">Deshabilitando servicios</a></li>
      </ul>
    </li>
    <li><a href="#resultado">Resultado</a></li>
  </ul>

  <ul>
    <li><a href="#mas-customización">Mas customización</a></li>
  </ul>
</nav></p>
		<h1 id="por-que-escapar-de-systemd">Por que escapar de systemd</h1>
<p>Porque quiero iniciar mi systema de manera kiss, usando lo mínimo necesario para que funcione bien y rápido.</p>
<p>En la mayoría de distros linux vienen activadas por defecto muchas cosas que no se acaban utilizando y usan recursos. Por suerte linux permite configurar el sistema a gusto bajo un control completo, pero &hellip; que pasa si quiero hacerme mi propio sistema de inicio?</p>
<p>Systemd es cada vez mas complicado, es un binario y cambiar cualquier cosa que no este predefinida implica cambiar el código fuente, compilar y probar. Los archivos de servicios unit de systemd son específicos solo para systemd, no son scripts que puedan funcionar sin systemd. Cada vez hacen mas aplicaciones dependiente de systemd como <a href="https://wiki.archlinux.org/index.php/Netctl">netctl de arch linux</a>.</p>
<p>No sigue la filosofía Unix, haz una cosa y hazla bien. Tampoco sigue mi filosofía KISS, hazlo simple. No tiene sentido hacer las cosas cada vez mas grandes con mas funcionalidades &hellip;  al final tendremos un programa (systemd) que lo hará todo, logs, control de usuarios, X, gestión de archivos, edición de vídeo, no necesitaremos nada mas pero &hellip;  No entraré en un debate ni daré una charla sobre si es bueno o no depender solo de un sistema, un programa, etc. cada uno que busque, compare y elija.</p>
<h2 id="comparando-systemas-de-inicio">Comparando systemas de inicio</h2>
<ul>
<li>
<p><a href="https://www.slant.co/topics/4663/~linux-init-systems">Comparativa de los diferentes systemas de inicio.</a></p>
</li>
<li>
<p><a href="https://www.distrowatch.com/search.php?ostype=All&amp;category=All&amp;origin=All&amp;basedon=All&amp;notbasedon=None&amp;desktop=All&amp;architecture=All&amp;package=All&amp;rolling=All&amp;isosize=All&amp;netinstall=All&amp;language=All&amp;defaultinit=SysV&amp;status=Active#simple">Para ver que systema de inicio tiene las diferentes distribuciones.</a></p>
</li>
</ul>
<p><img src="../../../en/posts/images/7-pstree.png" alt="Imagen comparativa de systemd y sysVinit"></p>
<h2 id="por-que-sysv-init">Por que sysV-init</h2>
<p>Después de indagar un poco sobre openrc, y sin que ningún sistema de inicio me acabe de convencer del todo, usaré SysVinit porque es el primero, está probado extensamente, es simple de entender y podemos reutilizar los scritps si queremos crear nuestro propio sistema de inicio.</p>
<p>Cada uno tendrá su sistema de inicio preferido, esta es la ventaja de usar software libre que tenemos varias opciones y si no nos gustan podemos hacerlo nosotros. Cada sistema de inicio tiene sus dependencias, ventajas e inconvenientes.</p>
<h2 id="removiendo-systemd">Removiendo systemd</h2>
<p>Partimos de una kali-mate-desktop donde instalé i3 y ajusté varias teclas y accesos rápidos a aplicaciones de mate, como mate-screenshoot. Para remplazar systemd con sysV-init <a href="https://linuxconfig.org/how-to-replace-systemd-with-sysv-init-on-debian-linux">seguiré este enlace</a> pero no añadiré los repositorios de devuan porque kali tiene sysV-init en sus repositorios.</p>
<p>Verificando que sysvinit esta en los repositorios</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# apt-cache search sysvinit
</span></span><span class="line"><span class="cl">acct - GNU Accounting utilities <span class="k">for</span> process and login accounting
</span></span><span class="line"><span class="cl">dumb-init - wrapper script which proxies signals to a child
</span></span><span class="line"><span class="cl">git-daemon-run - fast, scalable, distributed revision control system <span class="o">(</span>git-daemon service<span class="o">)</span>
</span></span><span class="line"><span class="cl">git-daemon-sysvinit - fast, scalable, distributed revision control system <span class="o">(</span>git-daemon service<span class="o">)</span>
</span></span><span class="line"><span class="cl">init-system-helpers - helper tools <span class="k">for</span> all init systems
</span></span><span class="line"><span class="cl">live-config-sysvinit - Live System Configuration Components <span class="o">(</span>sysvinit backend<span class="o">)</span>
</span></span><span class="line"><span class="cl">systemd-sysv - system and service manager - SysV links
</span></span><span class="line"><span class="cl">sysvinit-core - System-V-like init utilities
</span></span><span class="line"><span class="cl">sysvinit-utils - System-V-like utilities
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# 
</span></span></code></pre></div><p>Instalando sysvinit vemos como nos quita algunos paquetes que dependen de systed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~# apt install sysvinit-core sysvinit-utils
</span></span><span class="line"><span class="cl">Leyendo lista de paquetes... Hecho
</span></span><span class="line"><span class="cl">Creando árbol de dependencias       
</span></span><span class="line"><span class="cl">Leyendo la información de estado... Hecho
</span></span><span class="line"><span class="cl">Los paquetes indicados a continuación se instalaron de forma automática y ya no son necesarios.
</span></span><span class="line"><span class="cl">  accountsservice caja-common engrampa engrampa-common eom eom-common exfat-fuse exfat-utils ffmpegthumbnailer fonts-cantarell gir1.2-eom-1.0
</span></span><span class="line"><span class="cl">  gir1.2-matemenu-2.0 gvfs-common gvfs-libs libaccountsservice0 libappstream4 libatasmart4 libayatana-appindicator3-1 libayatana-ido3-0.4-0
</span></span><span class="line"><span class="cl">  libayatana-indicator3-7 libblockdev-crypto2 libblockdev-fs2 libblockdev-loop2 libblockdev-part-err2 libblockdev-part2 libblockdev-swap2 libblockdev-utils2
</span></span><span class="line"><span class="cl">  libblockdev2 libcpufreq0 libdbusmenu-glib4 libdbusmenu-gtk3-4 libexempi8 libffmpegthumbnailer4v5 libgdata-common libgdata22 libgoa-1.0-0b
</span></span><span class="line"><span class="cl">  libgoa-1.0-common libgphoto2-6 libgphoto2-l10n libgphoto2-port12 libgtkmm-3.0-1v5 libgucharmap-2-90-7 libindicator3-7 liblightdm-gobject-1-0
</span></span><span class="line"><span class="cl">  libmate-desktop-2-17 libmate-menu2 libmate-panel-applet-4-1 libmate-slab0 libmate-window-settings1 libmatedict6 libmatekbd-common libmatekbd4
</span></span><span class="line"><span class="cl">  libmatemixer-common libmatemixer0 libmateweather-common libmateweather1 libndp0 libnfs12 libnma0 liboauth0 librda-common librda0 libstemmer0d libteamdctl0
</span></span><span class="line"><span class="cl">  libudisks2-0 libvolume-key1 libxklavier16 lightdm-gtk-greeter mate-applets-common mate-backgrounds mate-calc mate-calc-common mate-control-center-common
</span></span><span class="line"><span class="cl">  mate-desktop mate-icon-theme mate-media mate-media-common mate-menus mate-panel-common mate-polkit-common mate-power-manager-common mate-screensaver
</span></span><span class="line"><span class="cl">  mate-screensaver-common mate-settings-daemon-common mate-system-monitor mate-system-monitor-common mate-themes mate-user-guide mate-utils
</span></span><span class="line"><span class="cl">  mate-utils-common menu menu-xdg mobile-broadband-provider-info
</span></span><span class="line"><span class="cl">Utilice «apt autoremove» para eliminarlos.
</span></span><span class="line"><span class="cl">Se instalarán los siguientes paquetes adicionales:
</span></span><span class="line"><span class="cl">  caja-common gvfs-libs initscripts insserv libmate-panel-applet-4-1 libmate-slab0 libmate-window-settings1 libnm0 libnss-systemd libsystemd0
</span></span><span class="line"><span class="cl">  mate-applets-common mate-control-center-common mate-panel-common mate-power-manager-common startpar systemd sysv-rc
</span></span><span class="line"><span class="cl">Paquetes sugeridos:
</span></span><span class="line"><span class="cl">  bootchart2 systemd-container policykit-1 bootlogd
</span></span><span class="line"><span class="cl">Paquetes recomendados:
</span></span><span class="line"><span class="cl">  libpam-systemd
</span></span><span class="line"><span class="cl">Los siguientes paquetes se ELIMINARÁN:
</span></span><span class="line"><span class="cl">  caja dbus-user-session ettercap-graphical gvfs gvfs-backends gvfs-daemons kali-desktop-core kali-desktop-i3 kali-desktop-mate libpam-systemd lightdm
</span></span><span class="line"><span class="cl">  mate-applet-brisk-menu mate-applets mate-control-center mate-desktop-environment mate-desktop-environment-core mate-panel mate-polkit mate-power-manager
</span></span><span class="line"><span class="cl">  mate-settings-daemon network-manager network-manager-gnome packagekit packagekit-tools policykit-1 systemd-sysv udisks2
</span></span><span class="line"><span class="cl">Se instalarán los siguientes paquetes NUEVOS:
</span></span><span class="line"><span class="cl">  initscripts insserv startpar sysv-rc sysvinit-core
</span></span><span class="line"><span class="cl">Se actualizarán los siguientes paquetes:
</span></span><span class="line"><span class="cl">  caja-common gvfs-libs libmate-panel-applet-4-1 libmate-slab0 libmate-window-settings1 libnm0 libnss-systemd libsystemd0 mate-applets-common
</span></span><span class="line"><span class="cl">  mate-control-center-common mate-panel-common mate-power-manager-common systemd sysvinit-utils
</span></span><span class="line"><span class="cl"><span class="m">14</span> actualizados, <span class="m">5</span> nuevos se instalarán, <span class="m">27</span> para eliminar y <span class="m">667</span> no actualizados.
</span></span><span class="line"><span class="cl">Se necesita descargar 19,9 MB de archivos.
</span></span><span class="line"><span class="cl">Se liberarán 36,1 MB después de esta operación.
</span></span><span class="line"><span class="cl">¿Desea continuar? <span class="o">[</span>S/n<span class="o">]</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">---skipped---
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Desinstalando systemd-sysv <span class="o">(</span>241-7<span class="o">)</span> ...                                                                                                                        
</span></span><span class="line"><span class="cl">Seleccionando el paquete sysvinit-core previamente no seleccionado.                                                                                           
</span></span><span class="line"><span class="cl"><span class="o">(</span>Leyendo la base de datos ... <span class="m">535426</span> ficheros o directorios instalados actualmente.<span class="o">)</span>                                                                          
</span></span><span class="line"><span class="cl">Preparando para desempaquetar .../sysvinit-core_2.96-1_amd64.deb ...                                                                                          
</span></span><span class="line"><span class="cl">Desempaquetando sysvinit-core <span class="o">(</span>2.96-1<span class="o">)</span> ...                                                                                                                    
</span></span><span class="line"><span class="cl">Preparando para desempaquetar .../libnss-systemd_242-8_amd64.deb ...                                                                                          
</span></span><span class="line"><span class="cl">Desempaquetando libnss-systemd:amd64 <span class="o">(</span>242-8<span class="o">)</span> sobre <span class="o">(</span>241-7<span class="o">)</span> ...                                                                                                
</span></span><span class="line"><span class="cl">Preparando para desempaquetar .../systemd_242-8_amd64.deb ...                                                                                                 
</span></span><span class="line"><span class="cl">Desempaquetando systemd <span class="o">(</span>242-8<span class="o">)</span> sobre <span class="o">(</span>241-7<span class="o">)</span> ...                                                                                                             
</span></span><span class="line"><span class="cl">Preparando para desempaquetar .../libsystemd0_242-8_amd64.deb ...                                                                                             
</span></span><span class="line"><span class="cl">Desempaquetando libsystemd0:amd64 <span class="o">(</span>242-8<span class="o">)</span> sobre <span class="o">(</span>241-7<span class="o">)</span> ...                                                                                                   
</span></span><span class="line"><span class="cl">Configurando libsystemd0:amd64 <span class="o">(</span>242-8<span class="o">)</span> ...                                             
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Progreso: <span class="o">[</span>  8%<span class="o">]</span> <span class="o">[</span><span class="c1">###########.............................................................................................................................]</span>
</span></span></code></pre></div><p>Copiando inittab a nuestro etc.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~# cp /usr/share/sysvinit/inittab /etc/inittab
</span></span><span class="line"><span class="cl">root@kali:~#
</span></span></code></pre></div><p>Reiniciando el ordenador.</p>
<pre tabindex="0"><code>reboot 
</code></pre><p>Despues de reiniciar removemos systemd. Nos quita mas paquetes que dependen de el.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~# apt remove  --purge --auto-remove systemd
</span></span><span class="line"><span class="cl">Leyendo lista de paquetes... Hecho
</span></span><span class="line"><span class="cl">Creando árbol de dependencias       
</span></span><span class="line"><span class="cl">Leyendo la información de estado... Hecho
</span></span><span class="line"><span class="cl">Los siguientes paquetes se ELIMINARÁN:
</span></span><span class="line"><span class="cl">  accountsservice* caja-common* engrampa* engrampa-common* eom* eom-common* exfat-fuse* exfat-utils* ffmpegthumbnailer* fonts-cantarell* gir1.2-eom-1.0*
</span></span><span class="line"><span class="cl">  gir1.2-matemenu-2.0* gvfs-common* gvfs-libs* iio-sensor-proxy* libaccountsservice0* libappstream4* libatasmart4* libayatana-appindicator3-1*
</span></span><span class="line"><span class="cl">  libayatana-ido3-0.4-0* libayatana-indicator3-7* libblockdev-crypto2* libblockdev-fs2* libblockdev-loop2* libblockdev-part-err2* libblockdev-part2*
</span></span><span class="line"><span class="cl">  libblockdev-swap2* libblockdev-utils2* libblockdev2* libcpufreq0* libdbusmenu-glib4* libdbusmenu-gtk3-4* libexempi8* libffmpegthumbnailer4v5*
</span></span><span class="line"><span class="cl">  libgdata-common* libgdata22* libgoa-1.0-0b* libgoa-1.0-common* libgphoto2-6* libgphoto2-l10n* libgphoto2-port12* libgtkmm-3.0-1v5* libgucharmap-2-90-7*
</span></span><span class="line"><span class="cl">  libindicator3-7* liblightdm-gobject-1-0* libmate-desktop-2-17* libmate-menu2* libmate-panel-applet-4-1* libmate-slab0* libmate-window-settings1*
</span></span><span class="line"><span class="cl">  libmatedict6* libmatekbd-common* libmatekbd4* libmatemixer-common* libmatemixer0* libmateweather-common* libmateweather1* libndp0* libnfs12* libnma0*
</span></span><span class="line"><span class="cl">  libnss-systemd* liboauth0* libplymouth4* librda-common* librda0* libstemmer0d* libteamdctl0* libudisks2-0* libvolume-key1* libxklavier16*
</span></span><span class="line"><span class="cl">  lightdm-gtk-greeter* mate-applets-common* mate-backgrounds* mate-calc* mate-calc-common* mate-control-center-common* mate-desktop* mate-icon-theme*
</span></span><span class="line"><span class="cl">  mate-media* mate-media-common* mate-menus* mate-panel-common* mate-polkit-common* mate-power-manager-common* mate-screensaver* mate-screensaver-common*
</span></span><span class="line"><span class="cl">  mate-settings-daemon-common* mate-system-monitor* mate-system-monitor-common* mate-themes* mate-user-guide* mate-utils* mate-utils-common* menu* menu-xdg*
</span></span><span class="line"><span class="cl">  mobile-broadband-provider-info* plymouth* plymouth-label* systemd*
</span></span><span class="line"><span class="cl"><span class="m">0</span> actualizados, <span class="m">0</span> nuevos se instalarán, <span class="m">99</span> para eliminar y <span class="m">915</span> no actualizados.
</span></span><span class="line"><span class="cl">Se liberarán <span class="m">482</span> MB después de esta operación.
</span></span><span class="line"><span class="cl">¿Desea continuar? <span class="o">[</span>S/n<span class="o">]</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">---skipped---
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Desinstalando libmateweather-common <span class="o">(</span>1.22.0-1<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">Desinstalando libndp0:amd64 <span class="o">(</span>1.6-1+b1<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">Desinstalando libnfs12:amd64 <span class="o">(</span>3.0.0-2<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Progreso: <span class="o">[</span> 61%<span class="o">]</span> <span class="o">[</span><span class="c1">###################################################################################.....................................................] </span>
</span></span></code></pre></div><h2 id="todo-depende-de-systemd">Todo depende de systemd</h2>
<p>Podemos usar <strong>&ldquo;apt-cache depends paquete&rdquo;</strong> para ver las dependencias de un paquete, en este caso del gestor de archivos por defecto del escritorio mate, &ldquo;caja&rdquo;. Para ver todo el arbol de dependencias o las dependencias indirectas podemos usar apt-rdepends. Las dependencias indirectas son aquellas que no dependen directamente pero si por medio de otros paquetes, o así lo veo yo.</p>
<p>Para instalar apt-rdepends</p>
<pre tabindex="0"><code>apt install apt-rdepends
</code></pre><p>Vemos las dependencias de caja</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~# apt-rdepends caja <span class="p">|</span> grep systemd
</span></span><span class="line"><span class="cl">Reading package lists... Done
</span></span><span class="line"><span class="cl">Building dependency tree       
</span></span><span class="line"><span class="cl">Reading state information... Done
</span></span><span class="line"><span class="cl">  Depends: libsystemd0
</span></span><span class="line"><span class="cl">libsystemd0
</span></span><span class="line"><span class="cl">  Depends: libpam-systemd
</span></span><span class="line"><span class="cl">  Depends: libsystemd0 <span class="o">(</span>&gt;<span class="o">=</span> 209<span class="o">)</span>
</span></span><span class="line"><span class="cl">  Depends: libsystemd0
</span></span><span class="line"><span class="cl">  Depends: libsystemd0
</span></span><span class="line"><span class="cl">  PreDepends: libsystemd0
</span></span><span class="line"><span class="cl">libpam-systemd
</span></span><span class="line"><span class="cl">  Depends: systemd <span class="o">(=</span> 242-7<span class="o">)</span>
</span></span><span class="line"><span class="cl">  Depends: systemd-sysv
</span></span><span class="line"><span class="cl">systemd
</span></span><span class="line"><span class="cl">  Depends: libsystemd0 <span class="o">(=</span> 242-7<span class="o">)</span>
</span></span><span class="line"><span class="cl">systemd-sysv
</span></span><span class="line"><span class="cl">  PreDepends: systemd
</span></span><span class="line"><span class="cl">  Depends: libsystemd0 <span class="o">(</span>&gt;<span class="o">=</span> 213<span class="o">)</span>
</span></span><span class="line"><span class="cl">  Depends: systemd-sysv
</span></span><span class="line"><span class="cl">root@kali:~# 
</span></span></code></pre></div><p>Dependencias del paquete caja</p>
<pre tabindex="0"><code>caja --&gt; gvfs --&gt; gvfs-daemons --&gt; libsystemd0 --&gt; libpam-systemd --&gt; systemd
</code></pre><p>Podemos ver que muchos paquetes como caja o network-manager dependen de systemd &hellip;.</p>
<p>Después de purgar systemd vemos que nos queda un sistema roto, porque necesitamos iniciar la red manualmente, no apaga bien, le faltan paquetes como el file-manager de mate (caja), etc.</p>
<p>Llegados a este punto decido hacer mi propia iso de kali para instalar aplicaciones no dependientes como por ejemplo lxterminal, pcmanfs etc.</p>
<h1 id="personalizando-kali-linux">Personalizando Kali linux</h1>
<p>Objetivos Goals</p>
<ul>
<li>Utilizar sysVinit</li>
<li>i3wm como escritorio</li>
<li>Aplicaciones no dependientes y ligeras.</li>
</ul>
<h2 id="clonando-live-build-config">Clonando live-build-config</h2>
<p>Para poder clonar el git de kali y empezar a crear nuestra iso necesitamos instalar si no lo tenemos ya,</p>
<pre tabindex="0"><code>apt install curl git live-build cdebootstrap
</code></pre><p>Una vez instalado lo necesario clonaremos el git de kali-live</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~# git clone https://gitlab.com/kalilinux/build-scripts/live-build-config.git
</span></span><span class="line"><span class="cl">Clonando en <span class="s1">&#39;live-build-config&#39;</span>...
</span></span><span class="line"><span class="cl">remote: Enumerating objects: 3, <span class="k">done</span>.  
</span></span><span class="line"><span class="cl">remote: Counting objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, <span class="k">done</span>.                                    
</span></span><span class="line"><span class="cl">remote: Compressing objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, <span class="k">done</span>.                                 
</span></span><span class="line"><span class="cl">remote: Total <span class="m">1308</span> <span class="o">(</span>delta 0<span class="o">)</span>, reused <span class="m">1</span> <span class="o">(</span>delta 0<span class="o">)</span>                               
</span></span><span class="line"><span class="cl">Recibiendo objetos: 100% <span class="o">(</span>1308/1308<span class="o">)</span>, 3.76 MiB <span class="p">|</span> 654.00 KiB/s, listo.
</span></span><span class="line"><span class="cl">Resolviendo deltas: 100% <span class="o">(</span>682/682<span class="o">)</span>, listo.
</span></span><span class="line"><span class="cl">root@kali:~# <span class="nb">cd</span> live-build-config/
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# ls -la
</span></span><span class="line"><span class="cl">total <span class="m">24</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">5</span> root root  <span class="m">138</span> nov  <span class="m">2</span> 19:07 .
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">33</span> root root <span class="m">4096</span> nov  <span class="m">2</span> 19:07 ..
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root   <span class="m">33</span> nov  <span class="m">2</span> 19:07 auto
</span></span><span class="line"><span class="cl">lrwxrwxrwx  <span class="m">1</span> root root    <span class="m">8</span> nov  <span class="m">2</span> 19:07 build_all.sh -&gt; build.sh
</span></span><span class="line"><span class="cl">-rwxr-xr-x  <span class="m">1</span> root root <span class="m">4688</span> nov  <span class="m">2</span> 19:07 build.sh
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root  <span class="m">350</span> nov  <span class="m">2</span> 19:07 .getopt.sh
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">8</span> root root  <span class="m">163</span> nov  <span class="m">2</span> 19:07 .git
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root  <span class="m">181</span> nov  <span class="m">2</span> 19:07 .gitignore
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">13</span> root root  <span class="m">247</span> nov  <span class="m">2</span> 19:07 kali-config
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root  <span class="m">174</span> nov  <span class="m">2</span> 19:07 README.md
</span></span><span class="line"><span class="cl">root@kali:~# <span class="nb">cd</span> live-build-config/
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config#
</span></span></code></pre></div><h3 id="creando-nuestra-variante">Creando nuestra variante</h3>
<p>NOTA: No uséis ./build todabia. Este comando crea la iso. Necesitamos customizar antes de gastar tiempo y ancho de banda.</p>
<p>Para trabajar mas cómodamente sin cambiar las variantes existentes crearemos una nueva, copiaremos &ldquo;variant-i3wm&rdquo; y empezaremos a configurar.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config/kali-config# cp -r variant-i3wm variant-i3-custom
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config/kali-config# ls -la
</span></span><span class="line"><span class="cl">total <span class="m">4</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">14</span> root root  <span class="m">272</span> nov  <span class="m">8</span> 11:46 .
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">12</span> root root <span class="m">4096</span> nov  <span class="m">9</span> 17:17 ..
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">9</span> root root  <span class="m">146</span> nov  <span class="m">2</span> 19:07 common
</span></span><span class="line"><span class="cl">lrwxrwxrwx  <span class="m">1</span> root root   <span class="m">17</span> nov  <span class="m">8</span> 11:46 variant-default -&gt; variant-i3-custom
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">5</span> root root   <span class="m">63</span> nov  <span class="m">2</span> 19:07 variant-e17
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-gnome
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:56 variant-i3-custom
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-i3wm
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-kde
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-large
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-light
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-lxde
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-mate
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root   <span class="m">20</span> nov  <span class="m">2</span> 19:07 variant-minimal
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-xfce
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config/kali-config#
</span></span></code></pre></div><p>Existen tres puntos claves que usaré para customizar la iso:</p>
<ul>
<li>Paquetes que contendrá nuestra iso y podremos instalar en disco. Bajo el dir <strong>kali-config/nuestra-variante/package-lists/</strong></li>
<li>Archivos, scripts, temas, wallpapers, que añadiremos a la iso, bajo el dir  <strong>kali-config/common/includes.chroot/</strong>. Este dir será como la raiz /. El script copiara estos archivos en la iso cuando haga el change root (chroot).</li>
<li>Hooks para arrancar/parar servicios, lanzar scripts, etc. Bajo el dir <strong>config/hooks/</strong> donde tendremos los hooks a ejecutar si arrancamos la iso en vivo en el dir &ldquo;live&rdquo; y para ejecutar hooks durante la instalacion en el dir &ldquo;normal&rdquo;.</li>
</ul>
<p>Para ver que metapaquetes tengo instalados en mi sistema por si me interesa añadir alguno.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config/kali-config# apt-cache show <span class="k">$(</span>dpkg-query -Wf <span class="s1">&#39;${Package}\n&#39;</span><span class="k">)</span> <span class="p">|</span> awk <span class="s1">&#39;$1 == &#34;Package:&#34; { pkg = $2 }; $1 == &#34;Section:&#34; &amp;&amp; $2 ~ /metapackage/ { print pkg }&#39;</span>
</span></span><span class="line"><span class="cl">firmware-linux
</span></span><span class="line"><span class="cl">firmware-linux
</span></span><span class="line"><span class="cl">firmware-linux-nonfree
</span></span><span class="line"><span class="cl">firmware-linux-nonfree
</span></span><span class="line"><span class="cl">init
</span></span><span class="line"><span class="cl">kali-desktop-live
</span></span><span class="line"><span class="cl">kali-desktop-live
</span></span><span class="line"><span class="cl">kali-linux-core
</span></span><span class="line"><span class="cl">kali-linux-core
</span></span><span class="line"><span class="cl">kali-linux-default
</span></span><span class="line"><span class="cl">kali-linux-default
</span></span><span class="line"><span class="cl">libreoffice
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config/kali-config# 
</span></span></code></pre></div><h2 id="primer-intento-para-crear-la-iso">Primer intento para crear la iso</h2>
<h3 id="copiando-mi-config-para-i3">Copiando mi config para i3</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# mkdir kali-config/common/includes.chroot/root/.config
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# cp /root/data/config/.config/i3/config kali-config/common/includes.chroot/root/.config/i3/config
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# cp /root/data/config/.config/i3/i3bar-script.sh kali-config/common/includes.chroot/root/.config/i3/i3bar-script.sh
</span></span></code></pre></div><h3 id="añadiendo-algunos-paquetes">Añadiendo algunos paquetes</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# cat kali-config/variant-i3-custom/package-lists/kali.list.chroot 
</span></span><span class="line"><span class="cl"><span class="c1"># You always want those</span>
</span></span><span class="line"><span class="cl">kali-linux-core
</span></span><span class="line"><span class="cl">kali-desktop-live
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Kali applications</span>
</span></span><span class="line"><span class="cl"><span class="c1">#&lt;package&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># You can customize the set of Kali metapackages (groups of tools) to install</span>
</span></span><span class="line"><span class="cl"><span class="c1"># For the complete list see: https://tools.kali.org/kali-metapackages</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kali-linux-default</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kali-linux-large</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kali-linux-everything</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kali-tools-top10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Graphical desktop</span>
</span></span><span class="line"><span class="cl">kali-desktop-i3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Custom</span>
</span></span><span class="line"><span class="cl">ncdu htop feh dnsmasq ranger
</span></span><span class="line"><span class="cl"><span class="c1">#lxapearance gnome-theme-kali qt5ct qt4-qtconfig</span>
</span></span><span class="line"><span class="cl"><span class="c1">#vlc ffmpeg youtube-dl</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# 
</span></span></code></pre></div><h3 id="construyendo-la-iso--building">Construyendo la iso &hellip; building</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# ./build.sh --variant i3-custom  --verbose
</span></span><span class="line"><span class="cl"><span class="o">[</span>2019-11-08 11:57:06<span class="o">]</span> lb clean --purge
</span></span><span class="line"><span class="cl">P: Executing auto/clean script.
</span></span><span class="line"><span class="cl"><span class="o">[</span>2019-11-08 11:57:06<span class="o">]</span> lb clean noauto --purge
</span></span><span class="line"><span class="cl">P: Executing auto/clean script.
</span></span><span class="line"><span class="cl"><span class="o">[</span>2019-11-08 11:57:06<span class="o">]</span> lb clean noauto --all
</span></span><span class="line"><span class="cl">P: Cleaning chroot
</span></span><span class="line"><span class="cl">----skipped----
</span></span></code></pre></div><p>La iso que obtenemos tiene systemd, tiene mal las locales y una resolución de 700x400 &hellip; intentaremos cambiar estas cosas.</p>
<h2 id="segundo-intento--ronda-dos">Segundo intento .. ronda dos.</h2>
<h3 id="cambiando-systemd-por-sysvinit">Cambiando systemd por sysvinit</h3>
<p>Buscando systemd en los paquetes lo encontramos en &ldquo;config/package-lists/live.list.chroot&rdquo;, lo copiaremos a nuestra variante y cambiaremos systemd por syvinit.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# cat config/package-lists/live.list.chroot                                                                                      
</span></span><span class="line"><span class="cl">live-boot                                                                                                                                                     
</span></span><span class="line"><span class="cl">live-config                                                                                                                                                   
</span></span><span class="line"><span class="cl">live-config-systemd                                                                                                                                           
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# apt-cache search live-config                                                                                                   
</span></span><span class="line"><span class="cl">live-config - Live System Configuration Components                                                                                                            
</span></span><span class="line"><span class="cl">live-config-doc - Live System Configuration Components <span class="o">(</span>documentation<span class="o">)</span>                                                                                        
</span></span><span class="line"><span class="cl">live-config-systemd - Live System Configuration Components <span class="o">(</span>systemd backend<span class="o">)</span>                                                                                  
</span></span><span class="line"><span class="cl">live-config-sysvinit - Live System Configuration Components <span class="o">(</span>sysvinit backend<span class="o">)</span>                                                                                
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config#
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# cp config/package-lists/live.list.chroot  kali-config/variant-i3-custom/package-lists/
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# vi kali-config/variant-i3-custom/package-lists/live.list.chroot 
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# cat kali-config/variant-i3-custom/package-lists/live.list.chroot 
</span></span><span class="line"><span class="cl">live-boot
</span></span><span class="line"><span class="cl">live-config
</span></span><span class="line"><span class="cl">live-config-sysvinit
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# 
</span></span></code></pre></div><h4 id="en-toda-la-cara--in-the-face-">En toda la cara &hellip; In the face &hellip;</h4>
<p>Parece que no será tan fácil. La creación de la iso falla. Mirando el log que crea &ldquo;build.log&rdquo; vemos.</p>
<pre tabindex="0"><code>Some packages could not be installed. This may mean that you have                                                                                             
requested an impossible situation or if you are using the unstable                                                                                            
distribution that some required packages have not yet been created                                                                                            
or been moved out of Incoming.                                                                                                                                
The following information may help to resolve the situation:                                                                                                  
                                                                                                                                                              
The following packages have unmet dependencies:                                                                                                               
 libpam-systemd : Depends: systemd-sysv but it is not going to be installed                                                                                   
E: Unable to correct problems, you have held broken packages.                                                                                                 
P: Begin unmounting filesystems...                                                                                                                            
P: Saving caches...                                                                                                                                           
Reading package lists...                                                                                                                                      
Building dependency tree...                                                                                                                                   
Reading state information...        
</code></pre><h3 id="empezando-con-lo-minimo">Empezando con lo minimo</h3>
<p>En este <a href="https://www.debian.org/doc/manuals/debian-faq/ch-pkg_basics.en.html">link</a> podemos ver la prioridad de los paquetes que marcan los mantenedores de Debian.</p>
<p>Para ver una lista de los paquetes por prioridad standard.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# grep-aptavail -n -sPackage -FPriority standard                                                                        <span class="o">[</span>5/49783<span class="o">]</span>
</span></span><span class="line"><span class="cl">apt-listchanges                                                                                                                                               
</span></span><span class="line"><span class="cl">bash-completion                                                                                                                                               
</span></span><span class="line"><span class="cl">bind9-host                                                                                                                                                    
</span></span><span class="line"><span class="cl">bzip2                                                                                                                                                         
</span></span><span class="line"><span class="cl">dbus                                                                                                                                                          
</span></span><span class="line"><span class="cl">debian-faq
</span></span><span class="line"><span class="cl">doc-debian
</span></span><span class="line"><span class="cl">file
</span></span><span class="line"><span class="cl">gettext-base
</span></span><span class="line"><span class="cl">groff-base
</span></span><span class="line"><span class="cl">krb5-locales
</span></span><span class="line"><span class="cl">libc-l10n
</span></span><span class="line"><span class="cl">libevent-2.1-6
</span></span><span class="line"><span class="cl">libgssglue1
</span></span><span class="line"><span class="cl">liblockfile-bin
</span></span><span class="line"><span class="cl">libnfsidmap2
</span></span><span class="line"><span class="cl">libnss-systemd
</span></span><span class="line"><span class="cl">libpam-systemd
</span></span><span class="line"><span class="cl">librpcsecgss3
</span></span><span class="line"><span class="cl">libswitch-perl
</span></span><span class="line"><span class="cl">locales
</span></span><span class="line"><span class="cl">lsof
</span></span><span class="line"><span class="cl">man-db
</span></span><span class="line"><span class="cl">manpages
</span></span><span class="line"><span class="cl">mime-support
</span></span><span class="line"><span class="cl">ncurses-term
</span></span><span class="line"><span class="cl">netcat-traditional
</span></span><span class="line"><span class="cl">openssh-client
</span></span><span class="line"><span class="cl">pciutils
</span></span><span class="line"><span class="cl">perl
</span></span><span class="line"><span class="cl">perl-modules-5.30
</span></span><span class="line"><span class="cl">python
</span></span><span class="line"><span class="cl">python-minimal
</span></span><span class="line"><span class="cl">python2.7
</span></span><span class="line"><span class="cl">python3-reportbug
</span></span><span class="line"><span class="cl">reportbug
</span></span><span class="line"><span class="cl">telnet
</span></span><span class="line"><span class="cl">traceroute
</span></span><span class="line"><span class="cl">ucf
</span></span><span class="line"><span class="cl">wamerican
</span></span><span class="line"><span class="cl">wget
</span></span><span class="line"><span class="cl">xz-utils
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# 
</span></span></code></pre></div><p>Para ver la lista de los paquetes con prioridad required.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# grep-aptavail -n -sPackage -FPriority required
</span></span><span class="line"><span class="cl">apt
</span></span><span class="line"><span class="cl">base-files
</span></span><span class="line"><span class="cl">base-passwd
</span></span><span class="line"><span class="cl">bash
</span></span><span class="line"><span class="cl">bsdutils
</span></span><span class="line"><span class="cl">coreutils
</span></span><span class="line"><span class="cl">dash
</span></span><span class="line"><span class="cl">debconf
</span></span><span class="line"><span class="cl">debianutils
</span></span><span class="line"><span class="cl">diffutils
</span></span><span class="line"><span class="cl">dpkg
</span></span><span class="line"><span class="cl">e2fsprogs
</span></span><span class="line"><span class="cl">findutils
</span></span><span class="line"><span class="cl">gcc-9-base
</span></span><span class="line"><span class="cl">grep
</span></span><span class="line"><span class="cl">gzip
</span></span><span class="line"><span class="cl">hostname
</span></span><span class="line"><span class="cl">init-system-helpers
</span></span><span class="line"><span class="cl">libc-bin
</span></span><span class="line"><span class="cl">libpam-modules
</span></span><span class="line"><span class="cl">libpam-modules-bin
</span></span><span class="line"><span class="cl">libpam-runtime
</span></span><span class="line"><span class="cl">login
</span></span><span class="line"><span class="cl">mawk
</span></span><span class="line"><span class="cl">mount
</span></span><span class="line"><span class="cl">ncurses-base
</span></span><span class="line"><span class="cl">ncurses-bin
</span></span><span class="line"><span class="cl">passwd
</span></span><span class="line"><span class="cl">perl-base
</span></span><span class="line"><span class="cl">sed
</span></span><span class="line"><span class="cl">sysvinit-utils
</span></span><span class="line"><span class="cl">tar
</span></span><span class="line"><span class="cl">tzdata
</span></span><span class="line"><span class="cl">util-linux
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# 
</span></span></code></pre></div><p>Required son los paquetes mínimos que realmente necesita la ditro para funcionar. Entonces podemos cambiar standard.list.chroot por required. Tendremos que crear required.list.chroot y eliminar o comentar standard.list.chroot.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# cat config/package-lists/required.list.chroot 
</span></span><span class="line"><span class="cl">! Packages Priority required
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# cat config/package-lists/standard.list.chroot 
</span></span><span class="line"><span class="cl"><span class="c1">#! Packages Priority standard</span>
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# 
</span></span></code></pre></div><h4 id="mas-errores-de-dependencias">Mas errores de dependencias</h4>
<p>Necesitaremos depurar mas las dependencias de los paquetes, arrancar con lo mínimo no ha sido suficiente y nos salen mas errores de dependencias. Después de tres intentos &hellip;</p>
<pre tabindex="0"><code>The following packages have unmet dependencies:
 kali-desktop-i3 : Depends: kali-desktop-core but it is not going to be installed
 kali-desktop-live : Depends: florence but it is not going to be installed
</code></pre><pre tabindex="0"><code>The following packages have unmet dependencies:
 florence : Depends: libgtk-3-0 (&gt;= 3.3.16) but it is not going to be installed
 kali-desktop-core : Depends: dbus-user-session but it is not going to be installed
</code></pre><pre tabindex="0"><code>The following packages have unmet dependencies:
 dbus-user-session : Depends: libpam-systemd but it is not going to be installed
                     Recommends: systemd-sysv but it is not going to be installed
</code></pre><p>arreglados algunos errores, añadiendo florence, añadiendo dbus-user-session, sale otra vez libpam-systemd que depende de systemd, revisando metapaquete por metapaquete vemos que el que genera el problema es &hellip;  kali-desktop-i3.</p>
<p>Aquí podemos ver que efectivamente depende de systemd. XD</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# apt-rdepends kali-desktop-i3 <span class="p">|</span> grep systemd
</span></span><span class="line"><span class="cl">Reading package lists... Done
</span></span><span class="line"><span class="cl">Building dependency tree       
</span></span><span class="line"><span class="cl">Reading state information... Done
</span></span><span class="line"><span class="cl">  Depends: libsystemd0
</span></span><span class="line"><span class="cl">libsystemd0
</span></span><span class="line"><span class="cl">  Depends: libsystemd0
</span></span><span class="line"><span class="cl">  Depends: libpam-systemd
</span></span><span class="line"><span class="cl">  Depends: systemd
</span></span><span class="line"><span class="cl">  Depends: libsystemd0
</span></span><span class="line"><span class="cl">libpam-systemd
</span></span><span class="line"><span class="cl">  Depends: systemd <span class="o">(=</span> 242-7<span class="o">)</span>
</span></span><span class="line"><span class="cl">  Depends: systemd-sysv
</span></span><span class="line"><span class="cl">systemd
</span></span><span class="line"><span class="cl">  Depends: libsystemd0 <span class="o">(=</span> 242-7<span class="o">)</span>
</span></span><span class="line"><span class="cl">  PreDepends: libsystemd0
</span></span><span class="line"><span class="cl">systemd-sysv
</span></span><span class="line"><span class="cl">  PreDepends: systemd
</span></span><span class="line"><span class="cl">  Depends: libsystemd0 <span class="o">(</span>&gt;<span class="o">=</span> 209<span class="o">)</span>
</span></span><span class="line"><span class="cl">  Depends: libsystemd0 <span class="o">(</span>&gt;<span class="o">=</span> 221<span class="o">)</span>
</span></span><span class="line"><span class="cl">  PreDepends: libsystemd0
</span></span><span class="line"><span class="cl">  Depends: libsystemd0
</span></span><span class="line"><span class="cl">  Depends: systemd-sysv
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# 
</span></span></code></pre></div><h4 id="quitando-definitivamente-systemd">Quitando definitivamente systemd</h4>
<p>Para evitar systemd tendremos que remplazar el metapaquete kali-desktop-i3 por el paquete i3 en kali.list.chroot.</p>
<p>La lista de paquetes de &ldquo;kali.list.chroot&rdquo; queda así.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# cat kali-config/variant-i3-custom/package-lists/kali.list.chroot 
</span></span><span class="line"><span class="cl"><span class="c1"># You always want those</span>
</span></span><span class="line"><span class="cl">kali-linux-core
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kali-desktop-live
</span></span><span class="line"><span class="cl">florence
</span></span><span class="line"><span class="cl">libgtk-3-0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Kali applications</span>
</span></span><span class="line"><span class="cl"><span class="c1">#&lt;package&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># You can customize the set of Kali metapackages (groups of tools) to install</span>
</span></span><span class="line"><span class="cl"><span class="c1"># For the complete list see: https://tools.kali.org/kali-metapackages</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kali-linux-default</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kali-linux-large</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kali-linux-everything</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kali-tools-top10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Graphical desktop</span>
</span></span><span class="line"><span class="cl">i3
</span></span><span class="line"><span class="cl">xorg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Custom</span>
</span></span><span class="line"><span class="cl">ncdu htop feh dnsmasq ranger
</span></span><span class="line"><span class="cl"><span class="c1">#lxapearance gnome-theme-kali qt5ct qt4-qtconfig</span>
</span></span><span class="line"><span class="cl"><span class="c1">#vlc ffmpeg youtube-dl flameshoot</span>
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# 
</span></span></code></pre></div><h3 id="cambiando-locales">Cambiando locales</h3>
<p>En este enlace del manual de debian live <a href="https://live-team.pages.debian.net/live-manual/html/live-manual/customizing-run-time-behaviours.en.html#531">Customizing locale and language </a>podemos ver las opciones para cambiar las locales.</p>
<p>Como el script &ldquo;build.sh&rdquo; de los chicos de kali no permite opciones de locales tendremos que cambiar la linea en el propio script.</p>
<pre tabindex="0"><code>#run_and_log lb config -a $KALI_ARCH $KALI_CONFIG_OPTS &#34;$@&#34;
run_and_log lb config -a $KALI_ARCH $KALI_CONFIG_OPTS &#34;$@&#34; --bootappend-live &#34;boot=live components locales=es_ES.UTF-8 keyboard-layouts=es&#34;
</code></pre><h3 id="resolución-de-pantalla">Resolución de pantalla</h3>
<p>Para las primeras pruebas de la iso bastará con este script chapuzero para cambiar la resolución.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# cat <span class="s">&lt;&lt;EOF&gt; kali-config/common/includes.chroot/root/scripts/screen-resolution.sh 
</span></span></span><span class="line"><span class="cl"><span class="s">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">xrandr --output Virtual-0 --mode 1280x1024
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config#
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# chmod <span class="m">700</span> kali-config/common/includes.chroot/root/scripts/screen-resolution.sh
</span></span></code></pre></div><h3 id="deshabilitando-servicios">Deshabilitando servicios</h3>
<p>Para agilizar el inicio de la iso, se quedaba un minuto esperando levantar la red con dhcp, deshabilitaremos la red y algunos otros servicios con un hook.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# cat <span class="s">&lt;&lt;EOF&gt; config/hooks/live/disable.services.hook.chroot
</span></span></span><span class="line"><span class="cl"><span class="s">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">update-rc.d ssh remove
</span></span></span><span class="line"><span class="cl"><span class="s">update-rc.d apparmor remove
</span></span></span><span class="line"><span class="cl"><span class="s">update-rc.d pcscd remove
</span></span></span><span class="line"><span class="cl"><span class="s">update-rc.d networking remove
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# 
</span></span></code></pre></div><h2 id="resultado">Resultado</h2>
<p><img src="../../../en/posts/images/7-Kali-live-iso.gif" alt="Imagen gif del inicio de kali live iso customizada"></p>
<h1 id="que-queda-por-hacer">Que queda por hacer</h1>
<p>El objetivo final es tener una iso de kali linux con i3, que use pocos recursos, donde poder instalar aplicaciones bajo demanda, sin tener muchas aplicaciones por defecto que se tengan que actualizar y consuman datos. Funcional para el día a día. A lo mejor hacer otra iso para usar en recuperación de datos, forensia o demás. Ya se verá.</p>
<h2 id="mas-customización">Mas customización</h2>
<p>Añado algunos scripts y paquetes, y le cambio el nombre a variant-i3-viel.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@kali:~/live-build-config# <span class="nb">cd</span> kali-config/
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config/kali-config# ls -la
</span></span><span class="line"><span class="cl">total <span class="m">4</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">14</span> root root  <span class="m">272</span> nov  <span class="m">8</span> 11:46 .
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">12</span> root root <span class="m">4096</span> nov  <span class="m">9</span> 17:17 ..
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">9</span> root root  <span class="m">146</span> nov  <span class="m">2</span> 19:07 common
</span></span><span class="line"><span class="cl">lrwxrwxrwx  <span class="m">1</span> root root   <span class="m">17</span> nov  <span class="m">8</span> 11:46 variant-default -&gt; variant-i3-custom
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">5</span> root root   <span class="m">63</span> nov  <span class="m">2</span> 19:07 variant-e17
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-gnome
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:56 variant-i3-custom
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-i3wm
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-kde
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-large
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-light
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-lxde
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-mate
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root   <span class="m">20</span> nov  <span class="m">2</span> 19:07 variant-minimal
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root   <span class="m">27</span> nov  <span class="m">2</span> 19:07 variant-xfce
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config/kali-config# mv variant-i3-custom variant-i3-viel
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config/kali-config# 
</span></span><span class="line"><span class="cl">root@kali:~/live-build-config# ./build.sh --variant i3-viel  --verbose                                                                                        
</span></span><span class="line"><span class="cl"><span class="o">[</span>2019-11-10 19:19:10<span class="o">]</span> lb clean --purge
</span></span><span class="line"><span class="cl">P: Executing auto/clean script.
</span></span><span class="line"><span class="cl"><span class="o">[</span>2019-11-10 19:19:10<span class="o">]</span> lb clean noauto --purge
</span></span><span class="line"><span class="cl">P: Executing auto/clean script.
</span></span><span class="line"><span class="cl"><span class="o">[</span>2019-11-10 19:19:10<span class="o">]</span> lb clean noauto --all
</span></span><span class="line"><span class="cl">P: Cleaning chroot
</span></span><span class="line"><span class="cl">P: Executing auto/clean script.
</span></span><span class="line"><span class="cl"><span class="o">[</span>2019-11-10 19:19:36<span class="o">]</span> lb clean noauto --cache
</span></span><span class="line"><span class="cl"><span class="o">[</span>2019-11-10 19:19:38<span class="o">]</span> lb config -a amd64 --distribution kali-rolling -- --variant i3-viel --bootappend-live <span class="nv">boot</span><span class="o">=</span>live components <span class="nv">locales</span><span class="o">=</span>es_ES.UTF-8 keyboard-
</span></span><span class="line"><span class="cl"><span class="nv">layouts</span><span class="o">=</span>es
</span></span><span class="line"><span class="cl">P: Executing auto/config script.
</span></span><span class="line"><span class="cl">----skipped----
</span></span></code></pre></div><p>Seguiré actualizando la iso, cuando la tenga lista la subire a mi dropbox.</p>
<p><!-- raw HTML omitted -->back<!-- raw HTML omitted --></p>
<p>Referencias:</p>
<p><a href="https://www.kali.org/tutorials/my-custom-kali-linux-distribution/">My custom kali linux distribution</a></p>
<p><a href="https://docs.kali.org/development/live-build-a-custom-kali-iso">Live build a custom kali iso</a></p>
<p><a href="https://live-team.pages.debian.net/live-manual/html/live-manual/toc.en.html">Live iso manual from Debian</a></p>
<p>Licencia: <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC-BY-SA</a></p>

	 </article>
    </article>
</main>

		</div>
	</section><footer>
	Send your coments here --> 
	<a href="https://github.com/VielLosero/VielLosero.github.io">[Git]</a>
	<a href="mailto:viel.losero@gmail.com">[Email]</a>
	&lt;-- Envia tus comentarios aquí
	<p class=post-meta >PGP: 1418 39E8 065C 95F4 8E8D  C329 F878 16F5 B769 CD83</p>
	<p class=post-meta >Donate Bitcoin Address: bc1q6d245chm8t5sdkqjugwg3ce2c92m276ee4ksv4</p>
	<p>Copyright © 2019 2025 Viel Losero aka: 02112134243</p>
	<p>Powered by <a href="https://gohugo.io/">Hugo</a></p>
</footer>
</body>
</html>
